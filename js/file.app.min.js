"use strict";function modificar_url(a,b){if(b||(b=null),Modernizr.history){var c={pagina:b};window.history.pushState(c,null,a)}}function makeTitle(a){for(var b=a.split("-"),c=0;c<b.length;c++){var d=b[c];b[c]=d.charAt(0).toUpperCase()+d.slice(1)}return b.join(" ")}function back(a){window.history.back(),a.preventDefault()}jQuery(function(a){window.Carpeta=Backbone.Model.extend({urlRoot:"/api/carpeta",defaults:{id:"",url:"",pagina:"",carpeta:"",ruta:"",hijos:""}}),window.Archivo=Backbone.Model.extend({urlRoot:"/api/archivo",defaults:{id:"",url:"",tipo_archivo:"",carpeta:"",nombre:"",archivo:""}}),window.Pagina=Backbone.Model.extend({urlRoot:"/api/pagina",defaults:{id:"",nombre:""}}),window.CarpetaCollection=Backbone.Collection.extend({model:Carpeta,url:"/api/carpeta"}),window.ArchivoCollection=Backbone.Collection.extend({model:Archivo,url:"/api/archivo"});var b=function(b){return _.template(a("#"+b).html())};window.CarpetaListView=Backbone.View.extend({template:b("carpetaListViewTemplate"),initialize:function(){this.collection.bind("reset",this.render,this),this.collection.bind("add",this.render,this),this.render},render:function(){return a(this.el).html(this.template(this.model.toJSON())),_.each(this.collection.models,function(b){a(".carpetas").append(new CarpetaListItemView({model:b}).render().el).fadeIn("slow")},this),this}}),window.CarpetaListItemView=Backbone.View.extend({tagName:"li",className:"carpeta",template:b("carpetaListItemViewTemplate"),render:function(){return a(this.el).html(this.template(this.model.toJSON())),this},close:function(){a(this.el).unbind(),a(this.el).remove()}}),window.ArchivoListView=Backbone.View.extend({template:b("archivoListViewTemplate"),initialize:function(){this.collection.bind("reset",this.render,this),this.render(),this.collection.bind("add",this.add,this)},render:function(){return a(this.el).html(this.template(this.model)),this},add:function(b){var c=new ArchivoListItemView({model:b});a(".archivos").append(c.render().el).fadeIn("slow")}}),window.ArchivoListItemView=Backbone.View.extend({tagName:"li",className:"archivo",template:b("archivoListItemViewTemplate"),render:function(){return a(this.el).html(this.template(this.model.toJSON())),this},events:{"click a":"ver"},close:function(){a(this.el).unbind(),a(this.el).remove()},ver:function(b){if(void 0!==b.currentTarget.dataset)var c=b.currentTarget.dataset.carpeta,d=b.currentTarget.dataset.archivo,e=b.currentTarget.dataset.nombre;else var c=b.currentTarget.getAttribute("data-carpeta"),d=b.currentTarget.getAttribute("data-archivo"),e=b.currentTarget.getAttribute("data-nombre");var f="/archivos/"+c+"/"+d,g=new ArchivoItemView({model:this.model});a("#ccontainer").html('<a href="#archivos" class="back">Volver</a>'),a("#ccontainer").append(g.render().el),modificar_url(b.currentTarget.href,e),window.open(f),b.preventDefault()}}),window.ArchivoItemView=Backbone.View.extend({className:"detalle_archivo",template:b("archivoItemViewTemplate"),render:function(){return a(this.el).html(this.template(this.model.toJSON())),this}});var c=Backbone.Router.extend({routes:{archivos:"listar","archivos/:a1(/:a2)(/:a3)(/:a4)(/:a5)":"listarCarpeta"},initialize:function(){var b=new RegExp("(/)+$","g");this.route(/(.*)\/+$/,"trailFix",function(a){a=a.replace(b,""),this.navigate(a,!0)}),this.pagina=new Pagina,this.pagina_id=a("#micrositio").data("pagina-id"),this.pagina.fetch({data:{id:this.pagina_id}}),""==window.location.hash&&(window.location.hash="archivos")},listar:function(){this.carpetaList=new CarpetaCollection,this.carpetaList.fetch({data:{pagina_id:this.pagina_id}}),this.carpetaListView=new CarpetaListView({collection:this.carpetaList,model:this.pagina}),a("#ccontainer").html(this.carpetaListView.render().el)},listarCarpeta:function(){a("#container").append('<div id="loading"><span class="spinner"></span></div>').fadeIn("slow"),this.carpetaList=new CarpetaCollection,this.carpetaList.fetch({data:{hash:window.location.hash}}),this.archivoList=new ArchivoCollection,this.archivoList.fetch({data:{hash:window.location.hash},success:function(){a("#loading").remove()}}),this.carpetaListView=new CarpetaListView({collection:this.carpetaList,model:this.pagina}),this.archivoListView=new ArchivoListView({collection:this.archivoList,model:this.pagina}),0==a("#archivos").length&&a("#ccontainer").html('<a href="#archivos" class="back">Volver</a>'),a("#ccontainer").append(this.carpetaListView.render().el),a("#ccontainer").append(this.archivoListView.render().el)}});new c,Backbone.history.start(),a(document).on("click",".back",back)});